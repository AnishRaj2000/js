describe('Protected model', function() {
	var Base = Protected.extend({
		public_fields: [
			'id',
			'name'
		],
		private_fields: [
			'text',
			'tags'
		]
	});

	turtl.profile = new Profile();
	var keychain = turtl.profile.get('keychain');

	// replace our sync so it's mem-only (no IDB)
	var sync;
	beforeAll(function() {
		sync = Composer.sync;
		Composer.sync = function(method, model, options)
		{
			if(options.success) options.success();
		};
	});
	afterAll(function() {
		Composer.sync = sync;
	});

	it('generates and/or ensures existence of keys', function() {
		var base = new Base();

		expect(base.key).toBe(null);

		var key = base.generate_key();
		expect(Array.isArray(key)).toBe(true);
		expect(base.key).toBe(key);

		var base2 = new Base();
		base2.create_or_ensure_key();
		var key2 = base2.key;
		base2.create_or_ensure_key();
		var key3 = base2.key;

		expect(key2).toBe(key3);
	});

	it('encrypts/decrypts models', function(done) {
		var base = new Base({
			id: 6969,
			name: 'andrew',
			text: 'this will be encrypted',
			tags: 'dogs,chairs,yachts,etc'
		});

		var key = base.generate_key();

		base.serialize()
			.then(function(data) {
				var enc = data[0];
				var keys = Object.keys(enc).sort().join(',');
				expect(keys).toBe(['body', 'id', 'name'].join(','));
				return enc;
			})
			.then(function(enc) {
				var base2 = new Base(enc);
				base2.key = key;
				return base2.deserialize();
			})
			.then(function(data) {
				expect(data.text).toBe('this will be encrypted');
				expect(data.tags).toBe('dogs,chairs,yachts,etc');
			})
			.finally(done);
	});

	it('returns only private/body fields with safe_json()', function(done) {
		var base = new Base({
			id: 123,
			name: 'cwarrrrll',
			text: 'how many more lies must we listen to',
			tags: 'zombies,punks'
		});

		expect(JSON.stringify(base.safe_json())).toBe('{"id":123,"name":"cwarrrrll"}');

		var body = null;
		base.generate_key();
		base.serialize()
			.then(function() {
				body = base.safe_json().body;
			})
			.finally(function() {
				expect(typeof body).toBe('string');
				done();
			});
	});

	it('generates subkeys and finds it\'s decrypting key(s) properly', function() {
		var key = tcrypt.random_key();
		var parent = new Base({id: 1});
		var child = new Base({id: 2});
		parent.key = key;
		keychain.add_key(parent.id(), 'board', parent.key);

		child.generate_key();
		var childkey = child.key;
		child.generate_subkeys([ {b: parent.id(), k: parent.key} ]);

		child.key = null;

		var parent_key = keychain.find_key(parent.id());
		var found = child.find_key(undefined, {b: [{id: parent.id(), k: parent_key}]});
		expect(tcrypt.to_base64(found)).toBe(tcrypt.to_base64(childkey));
	});
});

describe('ProtectedShared model', function() {
	var key = {
		private: "LS0tLS1CRUdJTiBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQ0KVmVyc2lvbjogT3BlblBHUC5qcyB2MS4wLjENCkNvbW1lbnQ6IGh0dHA6Ly9vcGVucGdwanMub3JnDQoNCnhjWllCRlp6MW1jQkVBQ3U2SDIxWmhVN0NuSFlCQlhZR0lEV0lTMTRpK1BwZFkwaHhTUkgrWGFuaXZFUwpzYXRQNFdNYmYyM2I3cXY1dEZoRnZhQTlzdU82NkIrR0NkUWZlT0IzM3hPMlJYYTZlN3JZZlNjemVIbTMKOFRsNVQ1NGk3RWo1NUVGNGtUbHFnblh2RWZmU0l5Q3h2N2RrNHc1aklXMlNaRU81cFA1dldvTlZZbWZ2Cm9qa2xVeVEyYURDclV4aUNGOUVWbG1sYTZIMDVpOEZtYUJvN1BhOHlVcjhmQ3kxVk96UTAveUxBTmRWSgpXUGFVUVRXV090aUVPbDZ4aWJMQURHNHoxMW12RFZPMksrSVdjeENaclpBVU9Zb3dxVzYwbThFZnR1M3UKWVNiNHRGNlhVLzFvdjBhMXYyNFlhVDgzVnh6dktsRCtEaFoxVCtDUlFScEUzbGdpOG80MytjWTdkSU8yClRMWTEzc1R1ZU5tVmI2eXA5djVEbEdGWEgxL0hnZDlBZTZTZmJGL0J5RzZpVUxDYno4bHh4T1NHSHZNMgp5MHkvNTYxdkZHdUlYWEh4NE5vOE1HUkR2azJHc1N3MVorcWl3enAzQ0xMVmZUdnhBUzhuZ21lODRXUkIKQ2hwWndEYmhzQzZWV1JjNVNTZlpFUTJkOWpscGUvWnBNYk52dzBrMVdUWDdkdzBPTFk1SkJzTFlQMGVyClFkOURlbVZiOS9hNkpMV0RmbmpBb0VEYlhNVnFjNmNKa3IraFZqbmRvS3V0MGp1c2ZUa3FoejUvNUN4VQpidWJlaDBBUTlKSnRtZjZDdkNyeGtrOS9UdGRyRlFLWnFOUjV3bk42aDFsQ3IzUER0WjVaK2RieGNlNlAKajFibXJvZWFsZGYzQStnbDJEMjVJTDlaeTRxbWJiVS9hYW9nK3dBUkFRQUJBQS8vVUs4L0RpY0JORE1sClFSamhXc1l5NkpSMWZWNUt6SzlGWTRhbHJlNE9Ka3VaMlozTUFSVmZ1cGVWL2hhampwVDdBM0R1TW9nTApOWFZPMVc1RFJDRm1xdVZsR25nQXhSVytvNDlZUGc0ZFdCVVhCamNNSStBTDZmcTVtUHlsRjlVR3dqbnYKc0NnME5NclR0dDVuREtPbkFCandoUHJ2eEQ1a3gwYVYyNTFoN3kzalRwWFJuYmEvWDRQTkY4QkM2WVRGCi8zM1F3WVRVVk8rbm1mZEI0dmdzK1Z4T1FRUlE2NG5wMGVRUUcyUFpiR3ZJNVhabnFFNTAvdEs5STN6OApDaHlEdVUyVkJmWWVla1h1YU9ZQ01XQjNpU2t3ZFlqVlNWblh1SEs4RCtMV3l6TXhVelh6ZTU5UlloMzEKWXY2S1RpZ0JoQ3hNMDdUTWdXaHdEKzhFWEI0RXF6VkNPSnFKUVhsM2ZCOEs0VG50M0crVHV2KzdOZzA1ClppZUtmZUJDMVFtV1puSk81T1I3UjZCRk15WS9NaHVuSS9ISyttWXFaeWY2N3crdHpiVEl3Y2tETlAvcApNTEtHTUNSanliMElseEZrZml5WlUyZ0VxdEZLUC9COVBCMDRWK0lpQmhCMEd2Ui85QzVRT3VXZVVtNkQKa3BLa2JlT0Z2bXZhc2hhazZZeFVUUDBzbk9vanZxMW8rN1ZnOUlwTzgrbDdjVm1mVml5M3I4NVl0enRUClFEdjlEYXViOWFRek04THhHTEFQdWt5cDh3SDZ5a2JIQ1FlRlZLUEUyVGZyeVAyeGVYOE9lWjlYdWRjNApIQzVnTU00TG55LzlGSkhMVTRybWVGc0hqLzIyS0p4WDBOR3gzcUFSOFlJWVNrRWRlSHpzNVlrWjdIeEoKb08wU3pXNlN5VUVJQU50TG5oOVl3eGR6VndJelprd2ZzRHY1citvNUlPNzdqS29YN0xqdzk3S0M5L3c3CnVPVHp6UTFiYTFHd0dRK3doRXAvMC9uajdtNi82TzFhSitpejJFVE5HUTBEeXBYTUtISDczTEdscXUzSgpER1N3WG16M0RjL1A1dWg1VmJnTCtTY2VVdGk5b05WUlhWeXVDY1R1c045WVVvay8wL0k3OEdEVHBPM2gKTjVwa3ZncUFXZHZZcmk0MUkraWZqTTlJZ0FySWVrcW9FeVh3ZlRZMkxHbFovWkhzeHhzLzRYOTVPenlYCmIwV3ppbi8rdDhBRm8xRTl5ckNXRGVvaUliU1lhSGtFd0hSdWVBS0pDT0hQaFo0cDRQSklzSVo5WklJWQp0YTNFbkpNMU5IcWpFL0o5QTlNdmFYLzh1U0tqZVdPNkFQUUVFSUhpRTYya1c3UTdmaDJpUHVVSUFNd3UKOTU3UmhvbFRjTzRuNk1mNFhKYkdLZlRrZk5kUWZQT3U1TmVnMkhhaDYyUmZKNVNFYVM3WVdqZjZUTGpnCnZwOEYyNWZaUGRVajhTNW9zaXR4dTM4bzVmbVZ2SzluRXNQRkQxd0N4dDlFK0pNSFJWZEFBSlVWQTV1WApqbjM3eGNqbi9CYjNNVVpmajh1bXBTMzNCbk8wS3I1OThnNVNqN0owT2drdUptck0wTE5ENkZZUHI5bFMKcS9HUUc2VXdoUUpCRHRTeDY0a2ZPVVQ3Wk4rdmVnZkJGbTJwbXBRNHozU2lpb3ZySnhtMlNQS1luU2RICkF3UG13eCtsQ2draFh2RjNrR3JDYmpNR0lYeEJwdk5TSDZFYUVjR1U1MzJoeU1WTzdqZkFHa1pRZDRZVQpKdzV3WUtWS2NhUGxtZTRuanpvMmhZdjMvQ2dsQzVsbTFXZXJBbDhIL2k3dVNZNWMvUUF4NS9IZ3RNeksKaVltZmdsNVlkZUpQK2JxdzVwNnlTQjNPUEtWakxYNFpsaVlaNTdONytScU1XNzNoK25YV2hvc2U2RStJCjJDa09PQ1hwK3NQNXJDWGRlTjRNZ2hHZFBsTTltRjg1R2FWa2tHdDh0T2lKQ2tpVERaSUhERG52T0J0WApmNEN5djlCcDl4bVFIOTFQK0tNS0VLMUk2K25LTnhHR2x5SWJtR2JmSjNEcmgyS3hZZWVNbnRSSm1wdWkKdUlLNlFKSTdDWDZkMEFpWmp2V2RNbnp1b2lZSzRKVHVTV2xxcjFkS1cxL2VNczFtYUZTenMvMHZZZHFmCkZhOXJ3USszL0hBb3ZGeWhVSXJDN1JZTlNlVkpVOU1JMVorUXZvTE5BT25pTllWVUJTU0pDbG1QYjVpZgpVdUt4M05UdklDYXdqcC81RDBzcHhRdUd3ODBUWVc1a2NtVjNRR3g1YjI1aWNtOXpMbU52YmNMQmNnUVEKQVFnQUpnVUNWblBXY0FZTENRZ0hBd0lKRUtIMXk5Z2xXYjQ5QkJVSUFnb0RGZ0lCQWhzREFoNEJBQURPCkpBLy9lMStXZjlwOFJWYXBFemI2cHhrZjB3OGR2Q2ZWV1JEeldvc2J3aVNQcSsrV1VxK2R6dlZ6cnFFMAo3UlA3ejhUeS9GaXVtOHJpQ3hPajdtLzZIYkJvNTV5Qy9FTWdBMit2cmlSck44Y2x2S2lZSUdrU0huSGQKVjZpVWkvVnJDNHhpS3dhMlc2c2svc2d1WGJnamE5NTlqS1ZWanhFK24rYnFqcklDSmlNcGFtTk52aDEvCmRIRENESkZVRy9XVVRQTTNURTBSVzM4aXVuS3hjQjVkc3VZSnhkT0I1OU5IY044bU01ZHdkempiVkx6agp4amRibEFyNFZKTVhKRng0Wk1MVmhaL0R4OEx0bjVkQVRSNHFFR3JyODlGTlJxcEhYb1djM25tM0ZNaXUKaTh3Z3hXS2R4bUZOOTdKVnpWdGdjWjR6aUNaOCswYzMzN04rMmRaL3VKMm9ZWFlBbWttSHVrQXYyakFiCkw5S3VObUVVMVVmaXlZT2JrSkFwZHgrVm5KdlM4RmNYVy9PSGVyYVVTTXFLbGh5K0JIL05zYUtGZnNjVAptSEpoYzJWRG84a3g3V0E3d0dHSVM5dHY5MlJCU0ZLaW9ZWCt4UVlnc0FVT0tjalRQb1VYYlg1Q09FN1QKV3lSTWQ1TlBlNW15Ukh0TE5uV0EvN1dNWU1XdURyK0lBdTkzSEVROTh1NVE2Y1dpZ1dNN001Q1JnQjlmCnRkdFB6NGs2QmEyUVZZSXhHVDNpSnBISHE1eDlFOGZ5SU9ZUVJkeHhvaUpBMDJYTGxiMGNyTWNJc0hzdwpjbnFHK1ByL28zSEVNUmRvV1FKQUN6MWdndGYrQnJzK3VMRjNDbDMwaU1OdnpkQkd6T2ZubnNtSlJFTjYKR2lHenhoSFIzakJ3T1FBTkdiM2V0MFRWVkJiSHhsZ0VWblBXWndFUUFMWG9ZSUtlcmo4anFmenRvVXV1CmVnajRieWE0VFdDY2hrcHpDSjdsV1djbVZuYTNneHdtZEFYc1Q3QmFiNkdTZDhLVVNtTG5nRVg5Y1hsWgpJMzBFdk5EOEZyRkRxWUF3QjM1QThYN1NqKzhZbkJUek1ONUlNY1RSdUN0aGZXanNkcGRWNlJPUnZSbWEKQ1FKb0tkdzErTjM5VDhVTnVrU0I1YTBWUGhuSEx5dkZTdElFUy9LVC9EVVJLVVZCb3BsZW9Tak9vSG9UCjZodGJzend6ME5RM3lMSGtwMGZNS1UvYk0vdzJwcnhTZTBHc0dvSXl6bDE1WDRGZnY1ZklpdGl4V2w2bwpwOEJTSFFiU2I4bGRRc1hXZ3E1LzFRSWg0OC9Zc1lVTHdsZFhFS0ZJTmdMVmRSTEZ3YWtrL1J6dWl1eTgKL3dMMktBb1RTMm4xOFdBejBia3RWa3J5QjZ4MlNCcE1oRHhyalRCSXRpTVFUNzcwY0dhMjFMbitJRUNOCndodXo5MSs4Wmg1dThadmZ2d0JaaU1UYkV0OVliM1E3QjI2Z0ZRRUJjOEFKL2w3QURPbE9qMDMwM1NCRgpCUXE2N2ZHZ3UxalcxMWpRODJDSHB5T2NmcGt3YTlsOVNIUzZiUUNUcW8yU21XQUJGdmZvM3RrVVFKbWoKS1lOWlIzbStVRkxieXorSkt3Q3R4TXJlZjB0YjR0ejdieUQxTGYzUlJ6VGFDWFJJbUNlV1VpdHd2b2M1CjRqRUg0ZmZjKzdqaFkwUzBTL1RXVjk2UmlrRUYwc3NjNVFvaC9nbkdYSVpYTThMaXh4VERjcEVTNkl2ZgpiQXVIczc0eVBrRlhEZEVoQjMwakI2bEdXbllmbHkrK2M0SFZoamxwUDdSSm9LeHA0bzIxTnJVbkZMTXQKQ1VycEFCRUJBQUVBRC85cDBhQXkyL1FwTHFuNFJKUUwzcGVIR0Y0d2ZBNG5JV2JOY0ZXWGVYdWtrWnpDCnVzWStYZkFvY2V0NWYySm83emRUcmNnSCtQdVp1M0dEVWVOZkdwNXNRL2svYlVqeEZQK0c1bWlWaWcvSQoydHdSSTlkTnQxbWNVUk45eU55WGFOY2orZ240SkZPSXpSNW9sQWVsM28vRE0xUndJU2cyS2dwZHdYbTYKclRBM21qR0lNbytyc1lLSnJFNEJ4OGk2eDEyZ3kzSjNFWmFpQzVvY2IxZ1AyOU9ZQ0pkM0lNRDNmMkNpClczaHJIT0F1dDl0RDJpSktKZ3oweWFvK3RaNXZwOXdXTEs1SkpudFVPSjVtMlNXNnlLcUVzRUJOV1VHWQo2MGw1Ui9ucHJQQXpvam9wTTl0QzdGOVg4Zmg4R0JnZzEyRFJiRGltZzhyZS9QOUpJMXZoQ1FxazJ5VFMKZmYrVEtFNFhjLzVyd3JhK1RveTRHRmlCSDI1VW1OKzhQcTZ6V0h2Y1JIRzJUdzhXTk5DaXdaOWRtazNGClRCUkJ2Nm45MFZDM0x3R0gxclpxdXhCeUFkeTdxQTRqZVZuUDlNYTFyNUhEMXM5WmtkQnBGNEppTXFzUQpvQjZrRUZ4OThZUTBIS3NFem15WSsrWXgzM0xHOEZyZHRITnppUzF2UUEvN2o0eE95N2tiSklMNUM5VzAKUDhnZFpqcTNMaVgrS2FoMktuMzBOeGloRHovbEpKNkFhVmw1clFjVHhubHh3cThFTU1TQ3RQRjFnazFvClVXcUFqSFQ0MDR6Ky92UkNxTGJENzhITmJxTWVVRHBVU2lRSWVDckJXcW9lc2dhRjVhVWxoSDcyQkxJcgo2ZnZhM244eGhjb1lFbVhERllHZXpQN3NGRVZhVDM0dkZJM0xjUWdBMzQyQXM2cHVydEFjdFhlMTN0ek8KMy9HOXllRk5UK2kwbEVVME1HNHh5Y2ZLTDl4U3JYMitIdlBmN0JsblhSSFU2MEU4Nnc2MHl3VG8vbTNJCnNIa3NxczlTS2YrcmlzeDBTaW9ZVFJIaDBsb1pENUo2bTIzU2tmWkUwUjZ5SWVUZkZVTi96S0tLY21MNwo1ZlkzR0Y1Vm5yMG8wYW1tbE0rR2tKaHkvWjJiZVQ1RkZYL045dTVmOHVVQ1JPdk9rSmNxa0dIK2FBMU4KZnRTRWlXaWtNTWdYMkVIR29JWEdQOWdwZVJybDl3QitZOTg5TlFXUWVzR3BuR0EvRThEdFRLcy9YNHplCldYcFJIUFF5ZU5lcHRXOGQwUjExTUZlZEdmSlppR2hFbVFYVEJqRVloUnoyWEtRVGRwdFVKU3lGcE82bApBdElXVEZNcHdnYkN2VVpIVkphZGR3Z0EwRTk2MTlrYWFjWi9YeUJicHNiZWo4Q3JYb0JzaUlieXBOWmUKQUhzV3BFWjlqNnJsUFlqL0QwL3NpOU56SVVMNzZPbXZSTGdYYW93TVRZY0NFS2xkc1haV2VkbGhpdlRMCmFNR3dxTDY5d3VNNk1BM2lOQTdYaDI5dHRUdlZyeGwvSjExQmk5R3MvNkZUQng1SjZwUis1MytTOWtUaApFSXZXMDdDTjlGckExNzJVSkpncGhHODlMNnh4TG1sQmhBS284NHhrVEdvNXZmZ2JvT2kxd21uekhtbUsKYkl2Ym9ROU9tNmhjK1VMSzAvcVlDSXJVQ2o5U0dFa0pHZit1cHJXazUrQ0tSeGg0UVlCSVJsdUpDY1p1CjZZaXExWGl5bzJFeU5TbDhBdXhLTDRDZjAxREh2cG1VejYvamhjZkN4elNHVXVPZGtKMlhqWXBkeEJRYQozelh5bndmL1VnbEx3UnZRa3YxN3N2VTJSR2ZYaU5CSmVyazB6aXdsL2RFRTg0cTlNUmoxQTc3V0tLcWkKSW1qSncxSzVwZUVmakpMeWttc1ZGS2MrYmZJQTZwR09ndnQxZ3MrekhHZ0NiR0J1WW9IREloZUhVb3NDCnQweU9ZZ3FrdW1ueDRDTGJFeWZSZzJYTHJ0akxJVW5TNzQreDdXbWc1cVg0K1ZYODBOSWRsaTROVHFQSwoxQXdXcGk3ZUx0aEZNTjQ4TitMdUV1VUFMdEpsTWYzdE15YUVCTHBwZXdhclZQV0pLaUlFZER5clZrVHcKNTVnNFIxU1F4VjVobkFudVR4VGptSUp5SXdUa0ZPa0x4VVhVTXMweFc1azZKTlVKRzJKbi9ETFg3dWUrClBNcXdpb2w1RGpLUmdvV3NxZTNTc0Y0Ylo0MU9iTTk5bTNBcjVaL3F5K0dpMEhPSTVZdG13c0ZmQkJnQgpDQUFUQlFKV2M5WnpDUkNoOWN2WUpWbStQUUliREFBQWFSOFFBSmhvYThXSnZPcGFrczczdEs2T1lSeFEKU2EyZG40Rys2SkxjWkttaXREOC9WSDJTLy9GR2gyNGpUem1OdGs2Rm91WVE0em1vUnQ1bjQySXRSYWh0CmZ5eFczWitsa1JTcHB5TTRGZmIzL0Joa1E4WnhBaHB4RmNzUTBZTStPTFQ5Zm94OXI0QnhBNXJVaVpYSgo4R2JyeVJMNHBBQ3VJcU15ZjlKZE51S0tSMHhBQmE4amlLYTM0dXZJWkx5aTh5MDZtODBPRGE4VTg1VngKc3oxOGhuYndVTTdJZ1plbGlMZlJxdGF5bk55eVlJck5QK2lpSzhrYmlxbEtoVkI0dmwxYmU4WDNPb29hCkRad3FKL2RUTDhYdis4OVV0QWpuclN1ZXdkQ1NwWUE2bmovVS9iSENlZmQvZXJZYWFIWGNncWhWcUhabAppMDBQT0RWUXVQeXpVWVNyTlFuSENCTktPbmo0b0laTWpGZVpiMzdGRVkyWElOd2hqQjFCdS8zTDYyTFgKbzR6WGc4N1NrcDlDZlYxM25oWEozQWRpYys2bEs0RlpXWGdVdVVWY1BPNUgxZDZYTjVwTXlpOXVtWWtnCnJUNk9Yd2dneXpzaEoyalJzeE1CekVXclBCeTQ3Y045Vm56YTI3dGhSTU9BODJ6V0c0bXVyOS96eEZhcwpEYmFEaE8yS3ZESVhoS0tmOER3RmJYVDg0aWFwbjJsazFwdTJuelhFc1lDeVVMd1BRWXZzRkFndUc5N24KWUZRTEJEK1dFcEFkdnQ4VmZ4VHRUS1NMckd0ZzgxRzY0aWxLWWM2MGZwa2d2TUtPa0hnNDEyb2xkQmJjCmtNVC9mNHRPN2ROcGdpc3V0MWNrUUJOZ2tKd0cwTEJ2MnN1UXR1WEtCQkVKeUZrOFBIaXFub0pqT2FFMAoNCj03czNnDQotLS0tLUVORCBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQ0K",
		public: "LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tDQpWZXJzaW9uOiBPcGVuUEdQLmpzIHYxLjAuMQ0KQ29tbWVudDogaHR0cDovL29wZW5wZ3Bqcy5vcmcNCg0KeHNGTkJGWnoxbWNCRUFDdTZIMjFaaFU3Q25IWUJCWFlHSURXSVMxNGkrUHBkWTBoeFNSSCtYYW5pdkVTCnNhdFA0V01iZjIzYjdxdjV0RmhGdmFBOXN1TzY2QitHQ2RRZmVPQjMzeE8yUlhhNmU3cllmU2N6ZUhtMwo4VGw1VDU0aTdFajU1RUY0a1RscWduWHZFZmZTSXlDeHY3ZGs0dzVqSVcyU1pFTzVwUDV2V29OVlltZnYKb2prbFV5UTJhRENyVXhpQ0Y5RVZsbWxhNkgwNWk4Rm1hQm83UGE4eVVyOGZDeTFWT3pRMC95TEFOZFZKCldQYVVRVFdXT3RpRU9sNnhpYkxBREc0ejExbXZEVk8ySytJV2N4Q1pyWkFVT1lvd3FXNjBtOEVmdHUzdQpZU2I0dEY2WFUvMW92MGExdjI0WWFUODNWeHp2S2xEK0RoWjFUK0NSUVJwRTNsZ2k4bzQzK2NZN2RJTzIKVExZMTNzVHVlTm1WYjZ5cDl2NURsR0ZYSDEvSGdkOUFlNlNmYkYvQnlHNmlVTENiejhseHhPU0dIdk0yCnkweS81NjF2Rkd1SVhYSHg0Tm84TUdSRHZrMkdzU3cxWitxaXd6cDNDTExWZlR2eEFTOG5nbWU4NFdSQgpDaHBad0RiaHNDNlZXUmM1U1NmWkVRMmQ5amxwZS9acE1iTnZ3MGsxV1RYN2R3ME9MWTVKQnNMWVAwZXIKUWQ5RGVtVmI5L2E2SkxXRGZuakFvRURiWE1WcWM2Y0prcitoVmpuZG9LdXQwanVzZlRrcWh6NS81Q3hVCmJ1YmVoMEFROUpKdG1mNkN2Q3J4a2s5L1R0ZHJGUUtacU5SNXduTjZoMWxDcjNQRHRaNVorZGJ4Y2U2UApqMWJtcm9lYWxkZjNBK2dsMkQyNUlMOVp5NHFtYmJVL2Fhb2crd0FSQVFBQnpSTmhibVJ5WlhkQWJIbHYKYm1KeWIzTXVZMjl0d3NGeUJCQUJDQUFtQlFKV2M5WndCZ3NKQ0FjREFna1FvZlhMMkNWWnZqMEVGUWdDCkNnTVdBZ0VDR3dNQ0hnRUFBTTRrRC85N1g1Wi8ybnhGVnFrVE52cW5HUi9URHgyOEo5VlpFUE5haXh2QwpKSStyNzVaU3I1M085WE91b1RUdEUvdlB4UEw4V0s2Ynl1SUxFNlB1Yi9vZHNHam5uSUw4UXlBRGI2K3UKSkdzM3h5VzhxSmdnYVJJZWNkMVhxSlNMOVdzTGpHSXJCclpicXlUK3lDNWR1Q05yM24yTXBWV1BFVDZmCjV1cU9zZ0ltSXlscVkwMitIWDkwY01JTWtWUWI5WlJNOHpkTVRSRmJmeUs2Y3JGd0hsMnk1Z25GMDRIbgowMGR3M3lZemwzQjNPTnRVdk9QR04xdVVDdmhVa3hja1hIaGt3dFdGbjhQSHd1MmZsMEJOSGlvUWF1dnoKMFUxR3FrZGVoWnplZWJjVXlLNkx6Q0RGWXAzR1lVMzNzbFhOVzJCeG5qT0lKbno3UnpmZnMzN1oxbis0Cm5haGhkZ0NhU1llNlFDL2FNQnN2MHE0MllSVFZSK0xKZzV1UWtDbDNINVdjbTlMd1Z4ZGI4NGQ2dHBSSQp5b3FXSEw0RWY4Mnhvb1YreHhPWWNtRnpaVU9qeVRIdFlEdkFZWWhMMjIvM1pFRklVcUtoaGY3RkJpQ3cKQlE0cHlOTStoUmR0ZmtJNFR0TmJKRXgzazA5N21iSkVlMHMyZFlEL3RZeGd4YTRPdjRnQzczY2NSRDN5CjdsRHB4YUtCWXpzemtKR0FIMSsxMjAvUGlUb0ZyWkJWZ2pFWlBlSW1rY2VybkgwVHgvSWc1aEJGM0hHaQpJa0RUWmN1VnZSeXN4d2l3ZXpCeWVvYjQrditqY2NReEYyaFpBa0FMUFdDQzEvNEd1ejY0c1hjS1hmU0kKdzIvTjBFYk01K2VleVlsRVEzb2FJYlBHRWRIZU1IQTVBQTBadmQ2M1JOVlVGczdCVFFSV2M5Wm5BUkFBCnRlaGdncDZ1UHlPcC9PMmhTNjU2Q1BodkpyaE5ZSnlHU25NSW51VlpaeVpXZHJlREhDWjBCZXhQc0ZwdgpvWkozd3BSS1l1ZUFSZjF4ZVZramZRUzgwUHdXc1VPcGdEQUhma0R4ZnRLUDd4aWNGUE13M2tneHhORzQKSzJGOWFPeDJsMVhwRTVHOUdab0pBbWdwM0RYNDNmMVB4UTI2UklIbHJSVStHY2N2SzhWSzBnUkw4cFA4Ck5SRXBSVUdpbVY2aEtNNmdlaFBxRzF1elBEUFExRGZJc2VTblI4d3BUOXN6L0RhbXZGSjdRYXdhZ2pMTwpYWGxmZ1YrL2w4aUsyTEZhWHFpbndGSWRCdEp2eVYxQ3hkYUNybi9WQWlIano5aXhoUXZDVjFjUW9VZzIKQXRWMUVzWEJxU1Q5SE82SzdMei9BdllvQ2hOTGFmWHhZRFBSdVMxV1N2SUhySFpJR2t5RVBHdU5NRWkyCkl4QlB2dlJ3WnJiVXVmNGdRSTNDRzdQM1g3eG1IbTd4bTkrL0FGbUl4TnNTMzFodmREc0hicUFWQVFGegp3QW4rWHNBTTZVNlBUZlRkSUVVRkNycnQ4YUM3V05iWFdORHpZSWVuSTV4K21UQnIyWDFJZExwdEFKT3EKalpLWllBRVc5K2plMlJSQW1hTXBnMWxIZWI1UVV0dkxQNGtyQUszRXl0NS9TMXZpM1B0dklQVXQvZEZICk5Ob0pkRWlZSjVaU0szQytoem5pTVFmaDk5ejd1T0ZqUkxSTDlOWlgzcEdLUVFYU3l4emxDaUgrQ2NaYwpobGN6d3VMSEZNTnlrUkxvaTk5c0M0ZXp2akkrUVZjTjBTRUhmU01IcVVaYWRoK1hMNzV6Z2RXR09Xay8KdEVtZ3JHbmlqYlUydFNjVXN5MEpTdWtBRVFFQUFjTEJYd1FZQVFnQUV3VUNWblBXY3drUW9mWEwyQ1ZaCnZqMENHd3dBQUdrZkVBQ1lhR3ZGaWJ6cVdwTE85N1N1am1FY1VFbXRuWitCdnVpUzNHU3BvclEvUDFSOQprdi94Um9kdUkwODVqYlpPaGFMbUVPTTVxRWJlWitOaUxVV29iWDhzVnQyZnBaRVVxYWNqT0JYMjkvd1kKWkVQR2NRSWFjUlhMRU5HRFBqaTAvWDZNZmErQWNRT2ExSW1WeWZCbTY4a1MrS1FBcmlLak1uL1NYVGJpCmlrZE1RQVd2STRpbXQrTHJ5R1M4b3ZNdE9wdk5EZzJ2RlBPVmNiTTlmSVoyOEZET3lJR1hwWWkzMGFyVwpzcHpjc21DS3pUL29vaXZKRzRxcFNvVlFlTDVkVzN2Rjl6cUtHZzJjS2lmM1V5L0Y3L3ZQVkxRSTU2MHIKbnNIUWtxV0FPcDQvMVAyeHdubjNmM3EyR21oMTNJS29WYWgyWll0TkR6ZzFVTGo4czFHRXF6VUp4d2dUClNqcDQrS0NHVEl4WG1XOSt4UkdObHlEY0lZd2RRYnY5eSt0aTE2T00xNFBPMHBLZlFuMWRkNTRWeWR3SApZblB1cFN1QldWbDRGTGxGWER6dVI5WGVsemVhVE1vdmJwbUpJSzAramw4SUlNczdJU2RvMGJNVEFjeEYKcXp3Y3VPM0RmVlo4MnR1N1lVVERnUE5zMWh1SnJxL2Y4OFJXckEyMmc0VHRpcnd5RjRTaW4vQThCVzEwCi9PSW1xWjlwWk5hYnRwODF4TEdBc2xDOEQwR0w3QlFJTGh2ZTUyQlVDd1EvbGhLUUhiN2ZGWDhVN1V5awppNnhyWVBOUnV1SXBTbUhPdEg2WklMekNqcEI0T05kcUpYUVczSkRFLzMrTFR1M1RhWUlyTHJkWEpFQVQKWUpDY0J0Q3diOXJMa0xibHlnUVJDY2haUER4NHFwNkNZem1oTkE9PQ0KPXVEangNCi0tLS0tRU5EIFBHUCBQVUJMSUMgS0VZIEJMT0NLLS0tLS0NCg0K"
	};
	var Message = ProtectedShared.extend({
	});

	it('encrypts/decrypts a payload properly (asymmetric)', function(done) {
		var msg = new Message({body: 'hello, simon'});
		msg.public_key = atob(key.public);
		var enc, dec;
		msg.encrypt()
			.then(function(_enc) {
				enc = _enc;
				var msg2 = new Message({body: enc});
				msg2.private_key = atob(key.private);
				return msg2.decrypt();
			})
			.then(function(_dec) {
				dec = _dec;
			})
			.finally(function() {
				expect(!!enc.match(/-BEGIN PGP MESSAGE/)).toBe(true);
				expect(dec).toBe('hello, simon');
				done();
			});
	});
});

